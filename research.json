<script>
let labData = null;

async function loadWagerXData() {
    try {
        // Cache buster included
        const url = 'https://cryptoplayer.github.io/wagerx/research.json?t=' + new Date().getTime();
        const response = await fetch(url);
        
        if (!response.ok) throw new Error('File not found on GitHub');
        
        const text = await response.text(); // Get raw text first
        try {
            labData = JSON.parse(text); // Try to turn text into a usable object
            console.log("WagerX Data Loaded Successfully");
        } catch (jsonError) {
            console.error("CRITICAL: Your research.json has a syntax error (missing comma or bracket)!");
            labData = "BROKEN"; // Flag it so we can show a safe message
        }
    } catch (error) {
        console.error("Network Error:", error);
    }
}

loadWagerXData();

function sendToLab() {
    var screen = document.getElementById('wagerx-log');
    var field = document.getElementById('wagerx-input');
    var cmd = field.value.trim().toLowerCase();
    
    if (!cmd) return;

    // User Message
    screen.innerHTML += `<div style="margin-bottom:20px; text-align:right;"><span style="background:#000; color:#fff; padding:12px 18px; border-radius:18px 18px 4px 18px; display:inline-block; font-size:15px;">${field.value}</span></div>`;
    field.value = "";

    setTimeout(function() {
        let reply = "I'm checking the latest audit logs...";

        // Handle the "Broken JSON" case gracefully
        if (labData === "BROKEN") {
            reply = "âš ï¸ **System Update in Progress:** My research database currently has a formatting error. Please check back in 5 minutes while my human auditor (Andreas) fixes the commas!";
        } 
        else if (!labData) {
            reply = "Connection slow... please try again in a second.";
        } 
        else {
            // SEARCH LOGIC
            const liveTest = labData.latest_blind_tests?.find(t => cmd.includes(t.casino.toLowerCase()));
            const generalInfo = labData.verified_casinos?.find(c => cmd.includes(c.name.toLowerCase()));

            if (liveTest) {
                reply = `<div style="border-left: 4px solid #00ff00; padding-left: 12px;">
                            <b style="color:#007bff; font-size:11px;">ðŸ”´ LIVE AUDIT PASS (${liveTest.date})</b><br>
                            <b style="font-size:18px;">${liveTest.casino}</b><br>
                            <p>${liveTest.note}</p>
                            <div style="background:#f1f3f5; padding:10px; border-radius:8px; font-size:14px;">
                                <b>Deposit:</b> ${liveTest.deposit} | <b>Withdraw:</b> ${liveTest.withdrawal}<br>
                                <b>KYC:</b> ${liveTest.kyc_triggered} | <b>Support:</b> ${liveTest.support_speed}
                            </div>
                         </div>`;
            } else if (generalInfo) {
                reply = `<b>Audit: ${generalInfo.name}</b><br>Trust Score: <b>${generalInfo.trust_score}/10</b><br>Status: ${generalInfo.status}`;
            } else if (cmd.includes("best") || cmd.includes("top")) {
                reply = labData.agent_responses?.best_casinos_intent?.answer || "See our top list at wagerx.io";
            }
        }

        screen.innerHTML += `<div style="margin-bottom:20px;"><span class="agent-label">WagerX AI</span><div style="background:#fff; color:#1a1a1a; padding:15px; border-radius:4px 18px 18px 18px; display:inline-block; border:1px solid #eee; font-size:16px; box-shadow: 0 2px 4px rgba(0,0,0,0.03);">${reply}</div></div>`;
        screen.scrollTop = screen.scrollHeight;
    }, 400);
}

document.getElementById('wagerx-input').onkeydown = function(e) { if (e.keyCode === 13) { e.preventDefault(); sendToLab(); } };
</script>
